C
      SUBROUTINE SCALEDM
      IMPLICIT REAL*8 (A-H, O-Z)
C
      INCLUDE 'diis.inc'
C
C === MULTIPLY THE DIAGONAL ELEMENTS OF THE DIIS MATRIX WITH 1.02
C === THIS STABILIZES THE PROCESS
C
      L = ILAST - IFIRST + 1
      DO 200 I = 1, L
      DIMAT(I,I) = DIMAT(I,I) * 1.02D0
  200 CONTINUE
C
C === WE NOW SUBTRACT ROW I FROM ROW I + 1
C === IN THIS WAY WE GET RID OF THE LANGRANGIAN MULTIPLIER
C === AND WE REDUCE THE DIMENSION OF THE PROBLEM WITH 1
C
      DO 300 I = ILAST - IFIRST + 1, 2, -1
      DO 310 J = 1, ILAST - IFIRST + 1
      DIMAT(I,J) = DIMAT(I,J) - DIMAT(I-1,J)
  310 CONTINUE
  300 CONTINUE
      DO 320 I = 1, ILAST - IFIRST + 1
      DIMAT(1,I) = -1.0D0
  320 CONTINUE
C
C === WE SCALE THE DIIS MATRIX
C
      L = ILAST - IFIRST + 1
      DO 100 K = 2, L
      RNORM = DIMAT(K,K)
      DO 110 I = 1, L
      DIMAT(K,I) = DIMAT(K,I) / RNORM
  110 CONTINUE
  100 CONTINUE
C
      RETURN
      END
