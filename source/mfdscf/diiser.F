C
      SUBROUTINE DIISER(FCR,FCI,FOR,FOI,FOCR,FOCI,DCR,DCI,DOR,DOI,
     +           DOCR,DOCI,SCRR1,SCRI1,SCRR2,SCRI2,SCRR3,SCRI3)
      IMPLICIT REAL*8 (A-H, O-Z)
C
C === THIS ROUTINE COMPUTES THE COMMUTATOR OF THE FOCK MATRIX
C === AND THE DENSITY MATRIX
C
      INCLUDE 'paracom.inc'
      INCLUDE 'general.inc'
      INCLUDE 'diis.inc'
C
      REAL*8 FCR(*), FCI(*), FOR(*), FOI(*)
      REAL*8 DCR(*), DCI(*), DOR(*), DOI(*)
      REAL*8 SCRR1(*), SCRI1(*), SCRR2(*), SCRI2(*)
      REAL*8 FOCR(*),FOCI(*),DOCR(*),DOCI(*),SCRR3(*),SCRI3(*)
C
      INTEGER NIDSRP(17)
C
      NIDSRP (1) = 0
      DO 10 IRP = 1 ,NSYMRP
      NIDSRP( IRP + 1) = NIDSRP( IRP ) + NBSIM(IRP) * NBSIM(IRP)
   10 CONTINUE
C
      ICE = 1
      IOE = 1
      IO2E= 1
      DO 100 IRP = 1, NSYMRP
      NB = NBSIM(IRP)
      NBS = NB * (NB + 1) / 2
      ISRP = NIDSRP(IRP) + 1
      NLR = NBLR(IRP)
      NSR = NBSR(IRP)
      NTR = NLR + NSR
      NTRS = NTR * (NTR + 1) / 2
C
C === WE START WITH THE CLOSED SHELL MATRICES
C
      IF (NCL(IRP) .NE. 0) THEN
C === WRITE THE FOCK MATRIX TO FILE
      CALL WDIIS(IDCYC,FCR(ISRP),FCI(ISRP),NB,IRP,1)
C === READ IN THE DENSITY MATRIX FOR THIS IRREP
      CALL RSDENS(IRECDC,DCR,DCI,NBS,IRP,1)
C === MAKE IT COMPLETE AND STORE IT IN IN DO AS A ROW WISE MATRIX
      IJC = 0
      DO 200 I = 1, NB
      IJO = I - NB
      JIO = (I - 1) * NB
      DO 205 J = 1, I
      IJC = IJC + 1
      IJO = IJO + NB
      JIO = JIO + 1
      DOR(IJO) = DCR(IJC)
      DOI(IJO) = -DCI(IJC)
      DOR(JIO) = DCR(IJC)
      DOI(JIO) = DCI(IJC)
  205 CONTINUE
  200 CONTINUE
C === TRANSFORM THE DENSITY MATRIX TO THE ORTHOGONAL BASIS
      CALL ORTHO(DOR,DOI,NBSIM1(IRP),NBSIM2(IRP),(IRP-1)*NREC,DCR(1),
     +           DCR(1+MSS),DCR(1+2*MSS),DCR(1+3*MSS),
     +           NBLR(IRP),NBSR(IRP),2)
C === ONLY THE UNDER TRIANGLE OF THE FOCK MATRIX AND THE DENSITY
C === MATRIX ARE CORRECT. TO BE ABLE TO COMPUTE THEIR COMMUTATOR
C === WE FIRST HAVE TO COMPLETE THESE MATRICES
      CALL MHERM(FCR(ISRP),FCI(ISRP),NB,NB)
      CALL MHERM(DOR,DOI,NB,NB)
C === COMPUTE THE COMMUTATOR OF F AND D AND STORE IT IN SCR1
      CALL COMFD(FCR(ISRP),FCI(ISRP),DOR,DOI,SCRR1(ICE),SCRI1(ICE),NB,
     +           NTR)
C === COMPUTE THE C**2 PART OF THE COMMUTATOR OF F AND D
      CALL SUBCSQ(TWOCSQ,DOR,DOI,SCRR1(ICE),SCRI1(ICE),NB,NTR,NLR,NSR)
C === WRITE THIS PART OF THE ERROR VECTOR TO FILE
      CALL WDIIS(IDCYC,SCRR1(ICE),SCRI1(ICE),NTRS,IRP,3)
      ICE = ICE + NTRS
      ENDIF
C === IF THERE IS AN OPEN SHELL NR.1 IN THIS IRREP WE DO IT ALL
C === ONCE AGAIN, BUT NOW FOR THE OPEN SHELL MATRICES
      IF (NOP(IRP,1) .NE. 0) THEN
      CALL WDIIS(IDCYC,FOR(ISRP),FOI(ISRP),NB,IRP,2)
      CALL RSDENS(IRECDC,DCR,DCI,NBS,IRP,2)
      IJC = 0
      DO 210 I = 1, NB
      IJO = I - NB
      JIO = (I - 1) * NB
      DO 220 J = 1, I
      IJC = IJC + 1
      IJO = IJO + NB
      JIO = JIO + 1
      DOR(IJO) = DCR(IJC)
      DOI(IJO) = -DCI(IJC)
      DOR(JIO) = DCR(IJC)
      DOI(JIO) = DCI(IJC)
  220 CONTINUE
  210 CONTINUE
      CALL ORTHO(DOR,DOI,NBSIM1(IRP),NBSIM2(IRP),(IRP-1)*NREC,DCR(1),
     +           DCR(1+MSS),DCR(1+2*MSS),DCR(1+3*MSS),
     +           NBLR(IRP),NBSR(IRP),2)
      CALL MHERM(FOR(ISRP),FOI(ISRP),NB,NB)
      CALL MHERM(DOR,DOI,NB,NB)
      CALL COMFD(FOR(ISRP),FOI(ISRP),DOR,DOI,SCRR2(IOE),SCRI2(IOE),NB,
     +           NTR)
      CALL SUBCSQ(TWOCSQ,DOR,DOI,SCRR2(IOE),SCRI2(IOE),NB,NTR,NLR,NSR)
      CALL WDIIS(IDCYC,SCRR2(IOE),SCRI2(IOE),NTRS,IRP,4)
      IOE = IOE + NTRS
      ENDIF
C === IF THERE IS AN OPEN SHELL NR.2 IN THIS IRREP WE DO IT ALL
C === ONCE AGAIN, BUT NOW FOR THE OPEN SHELL MATRICES
      IF (NOP(IRP,2) .NE. 0) THEN
      CALL WDIIS(IDCYC,FOCR(ISRP),FOCI(ISRP),NB,IRP,6)
      CALL RSDENS(IRECDC,DCR,DCI,NBS,IRP,3)
      IJC = 0
      DO 211 I = 1, NB
      IJO = I - NB
      JIO = (I - 1) * NB
      DO 221 J = 1, I
      IJC = IJC + 1
      IJO = IJO + NB
      JIO = JIO + 1
      DOCR(IJO) = DCR(IJC)
      DOCI(IJO) = -DCI(IJC)
      DOCR(JIO) = DCR(IJC)
      DOCI(JIO) = DCI(IJC)
  221 CONTINUE
  211 CONTINUE
      CALL ORTHO(DOCR,DOCI,NBSIM1(IRP),NBSIM2(IRP),(IRP-1)*NREC,DCR(1),
     +           DCR(1+MSS),DCR(1+2*MSS),DCR(1+3*MSS),
     +           NBLR(IRP),NBSR(IRP),2)
      CALL MHERM(FOCR(ISRP),FOCI(ISRP),NB,NB)
      CALL MHERM(DOCR,DOCI,NB,NB)
      CALL COMFD(FOCR(ISRP),FOCI(ISRP),DOCR,DOCI,SCRR3(IO2E),
     +           SCRI3(IO2E),NB,NTR)
      CALL SUBCSQ(TWOCSQ,DOCR,DOCI,SCRR3(IO2E),SCRI3(IO2E),NB,NTR,
     +            NLR,NSR)
      CALL WDIIS(IDCYC,SCRR3(IO2E),SCRI3(IO2E),NTRS,IRP,7)
      IO2E = IO2E + NTRS
      ENDIF
  100 CONTINUE
C
      RETURN
      END
