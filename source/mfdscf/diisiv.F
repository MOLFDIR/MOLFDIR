C
      SUBROUTINE DIISIV(DERR)
      IMPLICIT REAL*8 (A-H, O-Z)
C
C === THIS ROUTINE SOLVES THE DIIS EQUATION:
C === BIJ * CJ - L = 0 UNDER THE CONSTRAINT SUM(-CJ) = -1
C
      INCLUDE 'diis.inc'
C
      DIMENSION B(N30*N30),RHS(N30),WKSP1(N30),WKSP2(N30)
C
  100 CONTINUE
C
C === SOLVE THE DIIS EQUATIONS
C
      NM = N30
      N = ILAST - IFIRST + 1
      IERR = 1
      DO 110 I = 1, N
      RHS(I) = 0D0
  110 CONTINUE
      RHS(1) = -1.0D0
      CALL BSOLVE(DIMAT,NM,RHS,N,CVEC,B,NM,WKSP1,WKSP2,IERR)
C
C === CHECK IF THE MATRIX IS (NEARLY) SINGULAR
C === IF THE MATRIX IS NEARLY SINGULAR WE REMOVE THE OLDEST ROW AND COLLUMN
C === AND TRY AGAIN
C
      L = N30 * N30
      IF (IERR .NE. 0) THEN
      IF (IFIRST .EQ. ILAST) CALL Q2JOB(6,' SINGULAR 2X2 DIIS MATRIX ')
      CALL RDIIS(IDCYC,DIMAT,DIMAT,L,0,5)
      IFIRST = IFIRST + 1
      DO 120 K = 1, N30 - 1
      DO 130 J = 1, N30 - 1
      DIMAT(J,K) = DIMAT(J+1,K+1)
  130 CONTINUE
  120 CONTINUE
      CALL WDIIS(IDCYC,DIMAT,DIMAT,L,0,5)
      CALL SCALEDM
      GOTO 100
      ENDIF
C
      IF (PRDINF) THEN
      WRITE(6,1000) (CVEC(I),I=1,ILAST-IFIRST+1) 
      WRITE(6,1010) DERR
      ENDIF
 1000 FORMAT(//' THE DIIS COEFFICIENTS :'/5(2X,F5.2))
 1010 FORMAT(//' THE DIIS ERROR IS :',G12.4)
C
      RETURN
      END
